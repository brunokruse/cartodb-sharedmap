<!DOCTYPE html>
<html>
  <head>
    <title>Easy example | CartoDB.js</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <style>
      html, body, #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
    <link rel="stylesheet" href="http://leaflet.github.io/Leaflet.draw/leaflet.draw.css" />

  </head>
  <body>
    <div id="map"></div>

    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>
    <script src="http://leaflet.github.io/Leaflet.draw/leaflet.draw.js"></script>

  <script>

    var map = new L.Map('map', {
      zoomControl: false,
      center: [31.2000, 121.5000],
      zoom: 15
    });

    // ATTRIBUTES LAYER
    var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
    {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    });
    map.addLayer(layer);

    // DRAW CONTROLS
    var drawControl = new L.Control.Draw({
      position: 'topright',
      draw: {
        polyline: false,
        polygon: false,
        rectangle: false,
        circle: false,
        marker: true
      }
    });
    map.addControl(drawControl);

    cartodb.createLayer(map, 'https://brunokruse.cartodb.com/api/v2/viz/a9dbaafa-4a67-11e5-895b-0e4fddd5de28/viz.json')
      .addTo(map)
      .on('done', function(layer) {
        
        // Keep track of all draw objects
        var drawnItems = new L.FeatureGroup();
        //map.fitBounds(drawnItems.getBounds());
        map.addLayer(drawnItems);


        map.on('draw:created', function (e) {

          console.log(e);

          var type = e.layerType,
              layer = e.layer;

          if (type === 'marker') {
            // debug
            console.log("new point at: " + layer.getLatLng());

            // a popup
            layer.bindPopup('A popup!');

            // hardcoded to my account for now
            var username = "brunokruse";

            var lat = layer.getLatLng().lat;
            var lng = layer.getLatLng().lng;
            
            // finally write the points back into the table
            if (username != null) {
              //var sql = "INSERT INTO streetfood_evening_1 (the_geom, name, notes, taste) VALUES (ST_GeomFromText('POINT(" + lat + " " + lng + ")', 4326),'test_name', 'test_notes', 'test_taste',4326))&api_key=09eab12e2da17a5a3da49fe6bbf894a395920de2";
              //var sql = "INSERT INTO streetfood_evening_1 (the_geom, name, notes, taste) VALUES (ST_GeomFromText('POINT(" + lat + " " + lng + ")', 4326),'test_name', 'test_notes', 'test_taste')&api_key=09eab12e2da17a5a3da49fe6bbf894a395920de2";
              var sql = "INSERT INTO street_food_evenening_1 (the_geom, name) VALUES (ST_GeomFromText('POINT(" + lng + " " + lat + ")', 4326),'some place')&api_key=09eab12e2da17a5a3da49fe6bbf894a395920de2";
              $.ajax({
                url: 'https://brunokruse.cartodb.com/api/v2/sql?q='+sql,
                success: function(responseData, textStatus, jqXHR) {
                  console.log("Data saved");
                },
                error: function (responseData, textStatus, errorThrown) {
                  console.log("Problem saving the data");
                }
              });
            }
            
          }

          // Show the polygon on the map
          drawnItems.addLayer(layer);

          /*
          //SAVING DATA BACK TO CARTO
          // Get the coordinates of the polygon we just drew
          var poly = draw_layer.getLatLngs();
          var sql_poly = [];
          for (i in poly){
            sql_poly.push("CDB_LatLng("+poly[i].lat+","+poly[i].lng+")")
          }

          var line = "ST_MakeLine(Array["+sql_poly.join()+"])";
          //ST_GeomFromText(’POINT(-71.2 42.5)’, 4326)
          */

        });

      });
  </script>
</body>
</html>
